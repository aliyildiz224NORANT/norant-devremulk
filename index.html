<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NORANT Devremülk Satış Paneli</title>
<style>
  :root{
    --bg:#fff; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#2563eb;
    --ok:#16a34a; --warn:#f59e0b; --kpi:#f8fafc;
    --soldBg:#fff1f2; --soldText:#9f1239; --maintBg:#fff7d6; --maintText:#78350f;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:1400px;margin:auto;padding:20px}
  .head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
  .title{font-size:24px;font-weight:800}
  .subtitle{color:var(--muted);font-weight:600}
  .buttons{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px 12px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .save{font-size:12px;color:var(--muted)} .save.saving{color:var(--warn)} .save.saved{color:var(--ok)}
  .kpis{display:grid;grid-template-columns:repeat(5,minmax(220px,1fr));gap:10px;margin:14px 0 10px}
  .kpi{background:var(--kpi);border:1px solid var(--line);border-radius:12px;padding:14px}
  .kpi .cap{font-size:12px;color:var(--muted)} .kpi .val{font-size:18px;font-weight:800}
  .villaKpis{display:grid;grid-template-columns:repeat(6,minmax(170px,1fr));gap:8px;margin:2px 0 16px}
  .vk{background:#f9fafb;border:1px solid var(--line);border-radius:12px;padding:10px}
  .vk .cap{font-size:12px;color:var(--muted)} .vk .val{font-size:16px;font-weight:800}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
  .search{padding:10px;border:1px solid var(--line);border-radius:10px;min-width:340px}
  .legend{font-size:12px;color:var(--muted)}
  .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
  .tableWrap{border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:60vh}
  table{border-collapse:separate;border-spacing:0;min-width:max(1200px,100%)}
  thead th{position:sticky;top:0;background:#f3f4f6;border-bottom:1px solid var(--line);z-index:2}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);white-space:nowrap;vertical-align:top}
  tbody td:first-child, thead th:first-child{position:sticky;left:0;background:#f8fafc;z-index:1;font-weight:700}
  .cell{border:1px solid var(--line);border-radius:8px;padding:6px 10px;display:inline-block;user-select:none;cursor:pointer}
  .cell[draggable="true"]{cursor:grab}
  .sold{background:var(--soldBg);color:var(--soldText);border-color:#fecdd3}
  .maint{background:var(--maintBg);color:var(--maintText)}
  .note{font-size:11px;color:#475569;display:block;margin-top:4px;max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  dialog{border:1px solid var(--line);border-radius:12px;padding:0;max-width:760px;width:92%}
  .dlg-head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;font-weight:800}
  .dlg-tabs{display:flex;gap:6px}
  .tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;cursor:pointer;background:#fff}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}
  .dlg-body{padding:16px;display:none}
  .dlg-body.active{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{display:flex;flex-direction:column;gap:6px}
  .row input,.row textarea,.row select{padding:10px;border:1px solid var(--line);border-radius:10px}
  .dlg-foot{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
  /* arama sonuçları */
  .results{margin:10px 0 14px;border:1px solid var(--line);border-radius:12px;overflow:hidden;display:none}
  .resHead{background:#f8fafc;padding:10px 12px;font-weight:700;display:flex;justify-content:space-between}
  .resList{max-height:22vh;overflow:auto}
  .resItem{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid var(--line)}
  .resMeta{font-size:12px;color:#475569}
  .goBtn{padding:6px 10px;background:var(--accent);border:1px solid var(--accent);color:#fff;border-radius:8px;cursor:pointer;font-weight:700}
  /* context menu */
  .ctx{position:absolute;background:#fff;border:1px solid var(--line);box-shadow:0 8px 24px rgba(0,0,0,.15);border-radius:10px;padding:6px 0;z-index:9999;display:none}
  .ctx .i{padding:8px 14px;cursor:pointer;white-space:nowrap;font-size:14px}
  .ctx .i:hover{background:#f3f4f6}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(37,99,235,.8)}100%{box-shadow:0 0 0 8px rgba(37,99,235,0)}}
  .flash{animation:flash .9s ease-out 0s 2}
  @media (max-width:1100px){.villaKpis{grid-template-columns:repeat(3,minmax(170px,1fr))}}
  @media (max-width:700px){.kpis{grid-template-columns:1fr 1fr}.villaKpis{grid-template-columns:repeat(2,minmax(150px,1fr))}}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div>
      <div class="title">NORANT Devremülk Satış Paneli</div>
      <div class="subtitle">Küçük yatırımlarla büyük getiriler</div>
    </div>
    <div class="buttons">
      <span id="saveState" class="save saved">Kaydedildi</span>
      <button id="btnCsv" class="btn">Excel (CSV)</button>
      <button id="btnBackup" class="btn">Yedek indir (JSON)</button>
      <button id="btnCopy" class="btn">📋 Panoya kopyala</button>
      <label class="btn">Yedek yükle <input id="fileRestore" type="file" accept="application/json" style="display:none"></label>
      <button id="btnReset" class="btn">Tümünü sıfırla</button>
    </div>
  </div>

  <div id="kpis" class="kpis"></div>
  <div id="villaKpis" class="villaKpis"></div>

  <div class="toolbar">
    <input id="search" class="search" placeholder="Tarih (örn: 13-20 Haziran), müşteri, telefon, not, villa ara…">
    <span class="legend">Renkler: <span class="cell maint">Bakım</span> &nbsp; <span class="cell sold">Satıldı</span></span>
    <span class="pill">Bakım haftaları kilitlidir</span>
  </div>

  <div id="results" class="results">
    <div class="resHead"><span>Arama sonuçları</span><span id="resCount" class="resMeta">0 sonuç</span></div>
    <div id="resList" class="resList"></div>
  </div>

  <div class="tableWrap">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Düzenleme/Ödeme Diyaloğu -->
<dialog id="dlg">
  <div class="dlg-head">
    <div id="dlgTitle">Düzenle</div>
    <div class="dlg-tabs">
      <button class="tab active" data-tab="sale">Satış Detayı</button>
      <button class="tab" data-tab="pay">Ödeme Planı</button>
    </div>
  </div>

  <!-- Satış -->
  <div id="tab-sale" class="dlg-body active">
    <div class="row">
      <label>Durum</label>
      <select id="fStatus"><option value="Boş">Boş</option><option value="Satıldı">Satıldı</option></select>
    </div>
    <div class="row"><label>Müşteri</label><input id="fCustomer" placeholder="Ad Soyad"></div>
    <div class="row"><label>Telefon</label><input id="fPhone" placeholder="05xx xxx xx xx"></div>
    <div class="row"><label>Liste Fiyatı (TL)</label><input id="fList" type="number" min="0" step="100"></div>
    <div class="row"><label>İndirim (%)</label><input id="fDisc" type="number" min="0" max="100" step="1"></div>
    <div class="row"><label>Net Tutar (TL)</label><input id="fNet" type="number" disabled></div>
    <div class="row" style="grid-column:1/3"><label>Not</label><textarea id="fNote" rows="3"></textarea></div>
    <div class="row" style="grid-column:1/3;color:#475569;font-size:12px">Formül: Net = Liste × (1 − İndirim/100) • Kâr = Liste × 0.60 • KDV = Net × 0.18 • GV = Kâr × 0.20</div>
  </div>

  <!-- Ödeme -->
  <div id="tab-pay" class="dlg-body">
    <div class="row"><label>Peşinat (%)</label><input id="pDownPct" type="number" min="0" max="100" step="1" placeholder="50"></div>
    <div class="row"><label>Taksit Sayısı (Ay)</label><input id="pInst" type="number" min="0" step="1" placeholder="12"></div>
    <div class="row"><label>Peşinat Tutarı (TL)</label><input id="pDownAmt" type="number" disabled></div>
    <div class="row"><label>Aylık Taksit (TL)</label><input id="pMonthly" type="number" disabled></div>
    <div class="row"><label>Ödenen (TL)</label><input id="pPaid" type="number" min="0" step="100" placeholder="0"></div>
    <div class="row"><label>Kalan Borç (TL)</label><input id="pRemain" type="number" disabled></div>
    <div class="row" style="grid-column:1/3"><label>Ödeme Durumu</label><input id="pStatus" disabled></div>
  </div>

  <div class="dlg-foot">
    <button id="btnCancel" class="btn">İptal</button>
    <button id="btnSave" class="btn btn-primary">Kaydet</button>
  </div>
</dialog>

<!-- Sağ tık menüsü -->
<div id="ctx" class="ctx"></div>

<script>
/* ======= Sabitler ======= */
const WEEKS = [
 "12-19 Aralık","19-26 Aralık","26-3 Ocak","3-10 Ocak","10-17 Ocak","17-24 Ocak",
 "24-31 Ocak","31-7 Şubat","7-14 Şubat","14-21 Şubat","21-28 Şubat","28-7 Mart","7-14 Mart",
 "14-21 Mart","21-28 Mart","28-4 Nisan","4-11 Nisan","11-18 Nisan","18-25 Nisan",
 "25-2 Mayıs","2-9 Mayıs","9-16 Mayıs","16-23 Mayıs","23-30 Mayıs","30-6 Haziran","6-13 Haziran",
 "13-20 Haziran","20-27 Haziran","27-4 Temmuz","4-11 Temmuz","11-18 Temmuz","18-25 Temmuz",
 "25-1 Ağustos","1-8 Ağustos","8-15 Ağustos","15-22 Ağustos","22-29 Ağustos","29-5 Eylül","5-12 Eylül",
 "12-19 Eylül","19-26 Eylül","26-3 Ekim","3-10 Ekim","10-17 Ekim","17-24 Ekim",
 "24-31 Ekim","31-7 Kasım","7-14 Kasım","14-21 Kasım","21-28 Kasım","28-5 Aralık","5-12 Aralık"
];
// Bakım haftaları sabit (kilitli)
const MAINTENANCE = new Set(["14-21 Mart","21-28 Mart","12-19 Eylül","19-26 Eylül"]);

// Villalar sabit
const VILLAS = [
  "Ihlamur 1","Ihlamur 2","Zeytin 1","Zeytin 2","Zambak 1","Zambak 2"
];

// Finans oranları
const KAR_ORAN = 0.60;  // Liste fiyatı üzerinden %60
const KDV_ORAN = 0.18;  // Net tutar üzerinden %18
const GV_ORAN  = 0.20;  // Kâr üzerinden %20

// Kalıcı anahtar (asla değiştirme)
const STORAGE_KEY = "norant-satis-data";

// Global durum
let STATE = {};      // STATE[villa][week] = {status,list,disc,net,customer,phone,note,payment:{downPct,inst,paid}}
let saveTimer = null;
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const saveBadge = $("#saveState");

/* ======= Yardımcılar ======= */
function emptyCell(){
  return {
    status:"Boş", list:0, disc:0, net:0, customer:"", phone:"", note:"",
    payment:{ downPct:50, inst:12, paid:0 }
  };
}
function safeNumber(x){ const n = Number(x||0); return isFinite(n) ? n : 0; }
function calcNet(list,disc){
  const n = Math.round(safeNumber(list) * (1 - safeNumber(disc)/100));
  return Math.max(0,n);
}
function markSaving(){ saveBadge.textContent="Kaydediliyor…"; saveBadge.classList.add("saving"); saveBadge.classList.remove("saved"); }
function markSaved(){ saveBadge.textContent="Kaydedildi"; saveBadge.classList.remove("saving"); saveBadge.classList.add("saved"); }
function scheduleSave(){
  markSaving();
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }
    catch(e){ alert("Kayıt hatası: "+e.message); }
    markSaved();
  },250);
}
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    STATE = raw ? JSON.parse(raw) : {};
  }catch{ STATE = {}; }
  // eksikleri doldur
  for(const v of VILLAS){
    STATE[v] = STATE[v] || {};
    for(const w of WEEKS){
      const cur = STATE[v][w];
      if(!cur) STATE[v][w]=emptyCell();
      else{
        STATE[v][w] = { ...emptyCell(), ...cur };
        if(!STATE[v][w].payment) STATE[v][w].payment = {downPct:50,inst:12,paid:0};
      }
    }
  }
}

/* ======= Tablo çizimi ======= */
function renderHead(){
  const ths = ['<th>Villa</th>'];
  for(const w of WEEKS){
    ths.push(`<th>${MAINTENANCE.has(w)? (w+" 🛠️") : w}</th>`);
  }
  $("#thead").innerHTML = `<tr>${ths.join("")}</tr>`;
}
function renderBody(){
  const rows = [];
  for(const v of VILLAS){
    const tds = [`<td>${v}</td>`];
    for(const w of WEEKS){
      const r = STATE[v][w];
      const cls = ["cell"];
      if(MAINTENANCE.has(w)) cls.push("maint");
      if(r.status==="Satıldı") cls.push("sold");
      const infoNote = r.net>0 ? `<span class="note" title="Net: ${r.net.toLocaleString("tr-TR")} TL">₺ ${r.net.toLocaleString("tr-TR")}</span>`
                               : (r.note? `<span class="note">${r.note}</span>` : "");
      tds.push(`
        <td>
          <span class="${cls.join(" ")}" data-v="${v}" data-w="${w}" ${!MAINTENANCE.has(w)?'draggable="true"':''}
            title="${v} — ${w}\nDurum: ${r.status}${r.customer?`\nMüşteri: ${r.customer}`:""}${r.net?`\nNet: ${r.net.toLocaleString("tr-TR")} TL`:""}">
            ${r.status}
          </span>
          ${infoNote}
        </td>
      `);
    }
    rows.push(`<tr>${tds.join("")}</tr>`);
  }
  $("#tbody").innerHTML = rows.join("");

  // click → modal
  $$("#tbody .cell").forEach(el=>{
    el.addEventListener("click", ()=> openEditor(el.dataset.v, el.dataset.w));
  });

  // drag & drop
  $$("#tbody .cell").forEach(el=>{
    el.addEventListener("dragstart",(e)=>{
      e.dataTransfer.setData("text/plain", JSON.stringify({v:el.dataset.v,w:el.dataset.w}));
      e.dataTransfer.effectAllowed = "copyMove";
      el.classList.add("dragSrc");
    });
    el.addEventListener("dragend",()=> el.classList.remove("dragSrc"));
    el.addEventListener("dragover",(e)=>{
      if(MAINTENANCE.has(el.dataset.w)) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = (e.altKey ? "move" : "copy");
      el.classList.add("flash");
    });
    el.addEventListener("dragleave",()=> el.classList.remove("flash"));
    el.addEventListener("drop",(e)=>{
      e.preventDefault(); el.classList.remove("flash");
      if(MAINTENANCE.has(el.dataset.w)) return;
      const src = JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
      if(!src.v||!src.w) return;
      const from = STATE[src.v][src.w];
      STATE[el.dataset.v][el.dataset.w] = JSON.parse(JSON.stringify(from));
      if(e.altKey){ STATE[src.v][src.w]=emptyCell(); }
      scheduleSave(); renderAll();
    });
  });
}

/* ======= KPI hesapları ======= */
function occOf(v){
  let sold=0, revenue=0, listSum=0, kar=0, gv=0, kdv=0;
  for(const w of WEEKS){
    const r = STATE[v][w];
    if(r.status==="Satıldı"){
      sold++;
      const list= safeNumber(r.list), net= safeNumber(r.net);
      revenue += net;
      listSum += list;
      const k = list*KAR_ORAN;
      kar += k;
      gv  += k*GV_ORAN;
      kdv += net*KDV_ORAN;
    }
  }
  return { occ: Math.round(sold/WEEKS.length*100), revenue, kar, gv, kdv };
}
function globalKpi(){
  let sold=0, total=VILLAS.length*WEEKS.length;
  let revenue=0, kar=0, gv=0, kdv=0;
  for(const v of VILLAS){
    const o = occOf(v);
    revenue+=o.revenue; kar+=o.kar; gv+=o.gv; kdv+=o.kdv;
    sold += Math.round(o.occ*WEEKS.length/100);
  }
  const occ = Math.round(sold/total*100);
  return { occ, revenue, kar, gv, kdv, vergiTotal: kdv+gv, netKar: kar-gv };
}
function renderKpis(){
  const f = n=> Number(n||0).toLocaleString("tr-TR");
  const g = globalKpi();
  const box = (c,v,t="")=> `<div class="kpi" title="${t}"><div class="cap">${c}</div><div class="val">${v}</div></div>`;
  $("#kpis").innerHTML = [
    box("Genel Doluluk", `%${g.occ}`, "Satılan hafta / toplam"),
    box("Toplam Ciro", `${f(g.revenue)} TL`, "Net tutar toplamı"),
    box(`Kâr (%${Math.round(KAR_ORAN*100)})`, `${f(g.kar)} TL`, "Kâr = Liste × %60 (satılanlar)"),
    box("Vergi (KDV %18 + GV %20)", `${f(g.vergiTotal)} TL`, "KDV=Net×%18, GV=Kâr×%20"),
    box("Net Kâr", `${f(g.netKar)} TL`, "Net Kâr = Kâr − Gelir Vergisi (KDV hariç)")
  ].join("");

  $("#villaKpis").innerHTML = VILLAS.map(v=>{
    const o = occOf(v);
    return `<div class="vk" title="${v} doluluk & ciro">
      <div class="cap">${v}</div>
      <div class="val">%${o.occ} • ${Number(o.revenue).toLocaleString("tr-TR")} TL</div>
    </div>`;
  }).join("");
}

/* ======= Arama ======= */
const resBox = $("#results"), resCount=$("#resCount"), resList=$("#resList");
$("#search").addEventListener("input", (e)=>{
  const q = (e.target.value||"").trim().toLowerCase();
  if(!q){ resBox.style.display="none"; return; }
  const out=[];
  for(const v of VILLAS){
    for(const w of WEEKS){
      const r=STATE[v][w];
      const hay = [v,w,r.customer,r.phone,r.note,r.status].join(" | ").toLowerCase();
      if(hay.includes(q)) out.push({v,w,r});
    }
  }
  resCount.textContent = `${out.length} sonuç`;
  resList.innerHTML = out.slice(0,200).map(m=>`
    <div class="resItem">
      <div>
        <div><b>${m.v}</b> • ${m.w} ${MAINTENANCE.has(m.w)?'🛠️':''}</div>
        <div class="resMeta">Durum: ${m.r.status}${m.r.customer?` • Müşteri: ${m.r.customer}`:''}${m.r.net?` • Net: ₺${Number(m.r.net).toLocaleString("tr-TR")}`:''}</div>
      </div>
      <button class="goBtn" data-v="${m.v}" data-w="${m.w}">Git</button>
    </div>
  `).join("");
  resBox.style.display="";
  $$(".goBtn").forEach(b=>{
    b.onclick=()=>{
      const v=b.dataset.v, w=b.dataset.w;
      const cell = document.querySelector(`.cell[data-v="${CSS.escape(v)}"][data-w="${CSS.escape(w)}"]`);
      if(cell){ cell.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}); cell.classList.add("flash"); setTimeout(()=>cell.classList.remove("flash"),1600); }
    };
  });
});

/* ======= Modal (Satış & Ödeme) ======= */
const dlg = $("#dlg"), dlgTitle=$("#dlgTitle");
const fStatus=$("#fStatus"), fCustomer=$("#fCustomer"), fPhone=$("#fPhone"),
      fList=$("#fList"), fDisc=$("#fDisc"), fNet=$("#fNet"), fNote=$("#fNote");
const pDownPct=$("#pDownPct"), pInst=$("#pInst"), pDownAmt=$("#pDownAmt"),
      pMonthly=$("#pMonthly"), pPaid=$("#pPaid"), pRemain=$("#pRemain"), pStatus=$("#pStatus");
let CUR_V=null, CUR_W=null;

function setTab(which){
  $$(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab===which));
  $("#tab-sale").classList.toggle("active", which==="sale");
  $("#tab-pay").classList.toggle("active", which==="pay");
}
$$(".tab").forEach(t=> t.onclick=()=> setTab(t.dataset.tab));

function recomputePayment(){
  const net = safeNumber(fNet.value);
  const downPct = safeNumber(pDownPct.value);
  const inst = Math.max(0, parseInt(pInst.value||"0",10));
  const downAmt = Math.round(net * (downPct/100));
  const remainBase = Math.max(0, net - downAmt);
  const monthly = inst>0 ? Math.round(remainBase/inst) : 0;
  const paid = safeNumber(pPaid.value);
  const remain = Math.max(0, net - paid);
  pDownAmt.value = downAmt;
  pMonthly.value = monthly;
  pRemain.value  = remain;
  pStatus.value  = (net>0 && remain===0) ? "Tamamlandı" : "Devam Ediyor";
}
[fList,fDisc].forEach(inp=> inp.addEventListener("input", ()=>{
  fNet.value = calcNet(fList.value, fDisc.value);
  recomputePayment();
}));
[pDownPct,pInst,pPaid].forEach(inp=> inp.addEventListener("input", recomputePayment));

function openEditor(v,w){
  CUR_V=v; CUR_W=w;
  const isMaint = MAINTENANCE.has(w);
  const r = STATE[v][w];
  dlgTitle.textContent = `${v} — ${w}${isMaint?' (Bakım • kilitli)':''}`;
  fStatus.value = isMaint ? "Boş" : r.status;
  fStatus.disabled = isMaint;
  fCustomer.value = r.customer||"";
  fPhone.value = r.phone||"";
  fList.value = safeNumber(r.list);
  fDisc.value = safeNumber(r.disc);
  fNet.value  = calcNet(fList.value, fDisc.value);
  fNote.value = r.note||"";

  pDownPct.value = r.payment?.downPct ?? 50;
  pInst.value    = r.payment?.inst ?? 12;
  pPaid.value    = r.payment?.paid ?? 0;
  recomputePayment();

  setTab("sale");
  dlg.showModal();
}
$("#btnCancel").onclick = ()=> dlg.close();
$("#btnSave").onclick = ()=>{
  if(CUR_V==null) return;
  const isMaint = MAINTENANCE.has(CUR_W);
  const list = safeNumber(fList.value), disc=safeNumber(fDisc.value), net=calcNet(list,disc);
  STATE[CUR_V][CUR_W] = {
    status: isMaint ? "Boş" : fStatus.value,
    list, disc, net,
    customer: fCustomer.value||"", phone: fPhone.value||"", note: fNote.value||"",
    payment: { downPct: safeNumber(pDownPct.value), inst: safeNumber(pInst.value), paid: safeNumber(pPaid.value) }
  };
  scheduleSave(); renderAll(); dlg.close();
};

/* ======= Export / Import ======= */
$("#btnCsv").onclick = ()=>{
  const rows = [["Villa","Hafta","Durum","Bakım","ListeFiyatı","İndirim%","NetTutar","Müşteri","Telefon","Not","Peşinat%","TaksitAy","Ödenen"]];
  for(const v of VILLAS){
    for(const w of WEEKS){
      const r = STATE[v][w];
      rows.push([
        v,w,r.status, MAINTENANCE.has(w)?"Evet":"Hayır",
        safeNumber(r.list), safeNumber(r.disc), safeNumber(r.net),
        r.customer||"", r.phone||"", r.note||"",
        r.payment?.downPct ?? 50, r.payment?.inst ?? 12, r.payment?.paid ?? 0
      ]);
    }
  }
  const csv = rows.map(r=> r.map(x=> `"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"}), url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="norant_devremulk_satis.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$("#btnBackup").onclick = ()=>{
  const blob = new Blob([JSON.stringify(STATE,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="norant_satis_yedek.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$("#btnCopy").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(JSON.stringify(STATE,null,2));
    alert("Veriler panoya kopyalandı ✅");
  }catch(e){ alert("Kopyalama başarısız: "+e.message); }
};
$("#fileRestore").addEventListener("change",(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data = JSON.parse(String(r.result));
      // güvenli birleşim: sadece tanımlı villa/haftaları al
      for(const v of VILLAS){
        STATE[v] = STATE[v] || {};
        for(const w of WEEKS){
          const src = data?.[v]?.[w];
          STATE[v][w] = src ? { ...emptyCell(), ...src } : (STATE[v][w]||emptyCell());
          if(!STATE[v][w].payment) STATE[v][w].payment = {downPct:50,inst:12,paid:0};
        }
      }
      scheduleSave(); renderAll(); alert("Yedek yüklendi ✅");
    }catch{ alert("Dosya okunamadı / biçim hatalı"); }
  };
  r.readAsText(f);
});

/* ======= Reset ======= */
$("#btnReset").onclick = ()=>{
  if(!confirm("Tüm veriler sıfırlansın mı?")) return;
  STATE = {};
  for(const v of VILLAS){ STATE[v]={}; for(const w of WEEKS){ STATE[v][w]=emptyCell(); } }
  scheduleSave(); renderAll();
};

/* ======= Sağ tık menüsü ======= */
const ctx=$("#ctx"); let ACTIVE_CELL=null, COPY_BUF=null;
function ctxShow(x,y){ ctx.style.left=x+"px"; ctx.style.top=y+"px"; ctx.style.display="block"; }
function ctxHide(){ ctx.style.display="none"; }
function attachContextMenu(){
  ctx.innerHTML="";
  const add=(icon,txt,act)=>{ const d=document.createElement("div"); d.className="i"; d.dataset.act=act; d.textContent=`${icon} ${txt}`; ctx.appendChild(d); };
  add("🗑️","Satışı Sil","del");
  add("📋","Kopyala","copy");
  add("📦","Yapıştır","paste");
  add("🔁","Taşı","move");
  $$("#tbody .cell").forEach(el=>{
    el.oncontextmenu=(e)=>{
      e.preventDefault();
      const v=el.dataset.v, w=el.dataset.w;
      if(MAINTENANCE.has(w)) return;
      ACTIVE_CELL=el; ctxShow(e.pageX,e.pageY);
    };
    // mobil uzun basma
    let t=null;
    el.ontouchstart=()=>{ t=setTimeout(()=> el.dispatchEvent(new MouseEvent("contextmenu",{bubbles:true,cancelable:true})),600); };
    el.ontouchend=()=>{ if(t) clearTimeout(t); };
  });
}
document.addEventListener("click",(e)=>{ if(!ctx.contains(e.target)) ctxHide(); });
document.addEventListener("scroll", ctxHide);
ctx.addEventListener("click",(e)=>{
  const act=e.target.dataset.act; if(!act||!ACTIVE_CELL) return;
  const v=ACTIVE_CELL.dataset.v, w=ACTIVE_CELL.dataset.w;
  if(act==="del"){ STATE[v][w]=emptyCell(); }
  if(act==="copy"){ COPY_BUF = JSON.parse(JSON.stringify(STATE[v][w])); }
  if(act==="paste" && COPY_BUF){ STATE[v][w]=JSON.parse(JSON.stringify(COPY_BUF)); }
  if(act==="move" && COPY_BUF){ STATE[v][w]=JSON.parse(JSON.stringify(COPY_BUF)); /* güvenli mod: kaynağı elle sil */ }
  scheduleSave(); renderAll(); ctxHide();
});

/* ======= Başlat ======= */
function renderAll(){ renderHead(); renderBody(); renderKpis(); attachContextMenu(); }
load(); renderAll(); markSaved();
</script>
</body>
</html>
